name: Claude Code Review

on:
  pull_request:
    types: [opened, ready_for_review, synchronize]
    paths:
      - 'src/**'
      - 'benches/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  issue_comment:
    types: [created]  # Listen for @claude mentions in PR comments

concurrency:
  group: claude-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  claude-review:
    # Run if: (PR opened/ready/updated AND not draft AND no skip label) OR @claude review in PR comment
    if: |
      (github.event_name == 'pull_request' &&
       !github.event.pull_request.draft &&
       !contains(github.event.pull_request.labels.*.name, 'skip-review')) ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       (contains(github.event.comment.body, '@claude review') ||
        contains(github.event.comment.body, '@claude code review')))

    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Fetch PR Comments Context
        id: fetch-comments
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # GraphQL query to fetch all PR comments and review threads
          QUERY='query($owner: String!, $repo: String!, $prNumber: Int!) {
            repository(owner: $owner, name: $repo) {
              pullRequest(number: $prNumber) {
                comments(first: 100) {
                  totalCount
                  nodes {
                    author { login }
                    body
                    createdAt
                  }
                }
                reviewThreads(first: 100) {
                  totalCount
                  nodes {
                    isResolved
                    isOutdated
                    path
                    line
                    comments(first: 50) {
                      nodes {
                        author { login }
                        body
                        createdAt
                        diffHunk
                      }
                    }
                  }
                }
                reviews(first: 50) {
                  totalCount
                  nodes {
                    author { login }
                    body
                    state
                    createdAt
                  }
                }
              }
            }
          }'

          # Execute GraphQL query and check for errors
          if ! COMMENTS_JSON=$(gh api graphql \
            -f query="$QUERY" \
            -f owner="$REPO_OWNER" \
            -f repo="$REPO_NAME" \
            -F prNumber="$PR_NUMBER"); then
            echo "Warning: Failed to fetch PR comments. Proceeding without comment context."
            echo "⚠️ Unable to fetch existing comments due to API error." > /tmp/pr_comments_context.txt
            exit 0
          fi

          # Format comments for Claude using external Python script
          export COMMENTS_JSON
          python3 .github/scripts/format_pr_comments.py > /tmp/pr_comments_context.txt

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@23ed4cb53d6eacddbc22ec16652c98bcc54e0476 #v1.0.48
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API }}
          prompt: |
            <pr_context>
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
            LANGUAGE: Rust
            DOMAIN: Cryptographic threshold signatures library (FROST, ECDSA, EdDSA, BLS)
            </pr_context>

            <existing_discussions>
            $(cat /tmp/pr_comments_context.txt)
            </existing_discussions>

            <review_instructions>
            Analyze this pull request focusing on CRITICAL issues only. Keep feedback concise and actionable.

            **IMPORTANT - CONTEXT AWARENESS:**
            - Review the <existing_discussions> section above before providing feedback
            - Acknowledge and reference previous discussions when relevant
            - If a resolved thread addressed an issue, note that it was already fixed
            - Build upon previous feedback rather than duplicating it

            PRIORITY CHECKS (report only if found):
            1. Logic & Functionality
               - Logic flaws or incorrect implementations
               - Missing edge cases (empty inputs, boundary conditions, None/Some variants)
               - Unhandled error paths or panics in production code
               - Backward compatibility issues with existing APIs/data formats

            2. Cryptographic Safety
               - Secret comparisons must use constant-time operations (subtle::ConstantTimeEq), never == or !=
               - Secret key types must derive Zeroize/ZeroizeOnDrop; secrets must not linger in memory
               - Only cryptographically secure RNGs (OsRng) in non-test code; never thread_rng()
               - No secret material leaked in error messages, Display/Debug impls, or logs
               - No branching or indexing conditioned on secret data (timing side channels)
               - Verify scalar/point arithmetic uses the correct curve group
               - Serialization/deserialization of curve points must validate subgroup membership
               - Unsafe code in crypto paths requires extra scrutiny and safety comments

            3. Rust-Specific Concerns
               - Note: clippy already enforces deny(indexing-slicing, panic) and warn(unwrap-used, pedantic, nursery)
               - Focus on issues clippy CANNOT catch: logic errors, incorrect trait implementations, wrong algorithm choices
               - Unnecessary .clone() calls (suggest borrows/references instead)
               - Unsafe code without safety comments explaining invariants
               - Incorrect ownership patterns or lifetime issues
               - Improper error handling (unwrap/expect in library code)

            4. Code Quality
               - Poor modularity (functions >100 lines, god objects)
               - Unclear naming or missing documentation for public APIs
               - Violated Single Responsibility Principle
               - Hardcoded secrets or test keys leaking into non-test code

            REVIEW STYLE:
            - List only CRITICAL issues that need fixing before merge
            - Use bullet points, be direct and specific
            - Provide code examples for suggested fixes when helpful
            - If no critical issues: approve with brief summary
            - Sign off with: ✅ (approved) or ⚠️ (issues found)

            Consult the repository's CLAUDE.md file (if present) for project-specific conventions.
            Use `gh pr comment` to post your review.
            </review_instructions>

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh pr review:*)"'
